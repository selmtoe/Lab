<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TETRIS LAB - Personal Training Base</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<script src="https://www.youtube.com/iframe_api"></script>

<style>
    :root {
        --bg-color: #05050A;
        --card-bg: rgba(15, 15, 24, 0.6);
        --accent-color: #00E5FF;
        --accent-glow: rgba(0, 229, 255, 0.4);
        --text-main: #F0F0F5;
        --text-dim: #8B8B9E;
        --border-color: rgba(75, 75, 124, 0.4);
        --font-display: 'Orbitron', sans-serif;
        --font-ui: 'Noto Sans JP', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
        background-color: var(--bg-color);
        color: var(--text-main);
        font-family: var(--font-ui);
        overflow-x: hidden;
        line-height: 1.6;
    }
    h1, h2, h3, .orbitron { font-family: var(--font-display); letter-spacing: 1px; }
    
    /* Background Effect */
    #bg-canvas {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; opacity: 0.15; pointer-events: none;
    }

    /* Layout */
    .container {
        max-width: 1300px; margin: 0 auto; padding: 30px 20px;
        display: grid; grid-template-columns: 260px 1fr; gap: 40px; min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        padding: 30px 20px; border-radius: 16px;
        backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        height: fit-content; position: sticky; top: 30px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .logo {
        font-size: 28px; font-weight: 700; color: var(--accent-color);
        margin-bottom: 40px; text-shadow: 0 0 15px var(--accent-glow);
        cursor: pointer; text-align: center;
    }
    .nav-item {
        display: flex; align-items: center; padding: 14px 20px; margin-bottom: 12px;
        color: var(--text-dim); text-decoration: none; border-radius: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent; cursor: pointer; font-family: var(--font-display);
    }
    .nav-item:hover, .nav-item.active {
        background: rgba(0, 229, 255, 0.1);
        border-color: var(--accent-color); color: var(--accent-color);
        box-shadow: inset 0 0 20px rgba(0, 229, 255, 0.05);
    }
    
    /* Main Content */
    .main-content { padding-bottom: 50px; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .section-title {
        font-size: 32px; margin-bottom: 30px; color: #fff;
        border-bottom: 2px solid var(--accent-color);
        padding-bottom: 10px; display: inline-block;
        text-shadow: 0 0 10px var(--accent-glow);
    }

    /* Cards */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }
    .card {
        background: var(--card-bg); border: 1px solid var(--border-color);
        border-radius: 12px; padding: 24px; transition: all 0.3s;
        backdrop-filter: blur(8px); cursor: pointer; display: flex; flex-direction: column;
    }
    .card:hover {
        transform: translateY(-5px); border-color: var(--accent-color);
        box-shadow: 0 10px 30px rgba(0,0,0,0.6), 0 0 15px var(--accent-glow);
    }
    .card-meta { display: flex; justify-content: space-between; font-size: 0.85em; color: var(--text-dim); margin-bottom: 12px; }
    .card-title { font-size: 1.3em; font-weight: bold; margin-bottom: 12px; color: #fff; line-height: 1.4; }
    .tag {
        display: inline-block; padding: 4px 10px; font-size: 0.75em;
        border-radius: 4px; background: rgba(0, 229, 255, 0.15); color: var(--accent-color);
        border: 1px solid rgba(0, 229, 255, 0.3); margin: 0 6px 6px 0;
    }

    /* Article Reader */
    .article-header { margin-bottom: 30px; }
    .article-title { font-size: 2.5em; color: #fff; margin-bottom: 15px; }
    .article-body {
        background: var(--card-bg); border: 1px solid var(--border-color);
        border-radius: 12px; padding: 40px; font-size: 1.1em;
    }
    .article-body iframe { width: 100%; height: 600px; border: none; border-radius: 8px; margin: 20px 0; background: #000; }
    
    /* Related Articles */
    .related-section { margin-top: 50px; border-top: 1px solid var(--border-color); padding-top: 30px; }

    /* Video Embed */
    .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; border-radius: 8px; overflow: hidden; margin-bottom: 15px; background: #000;}
    .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
    .timestamp-list { display: flex; flex-direction: column; gap: 8px; }
    .timestamp-btn {
        background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: var(--text-main);
        padding: 8px 12px; border-radius: 6px; cursor: pointer; text-align: left; transition: 0.2s;
        display: flex; gap: 15px;
    }
    .timestamp-btn:hover { background: rgba(0, 229, 255, 0.1); border-color: var(--accent-color); }
    .time-badge { color: var(--accent-color); font-family: var(--font-display); font-weight: bold; }

    /* Buttons */
    .btn {
        display: inline-block; padding: 10px 20px; font-family: var(--font-display);
        background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color);
        text-decoration: none; border-radius: 6px; transition: 0.3s; cursor: pointer; text-align: center;
    }
    .btn:hover { background: var(--accent-color); color: #000; font-weight: bold; }
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<div class="container">
    <aside class="sidebar">
        <div class="logo orbitron" onclick="router('dashboard')">TETRIS LAB</div>
        <nav>
            <a class="nav-item active" onclick="router('dashboard')">DASHBOARD</a>
            <a class="nav-item" onclick="router('articles')">ARTICLES</a>
            <a class="nav-item" onclick="router('videos')">VIDEOS</a>
            <a class="nav-item" onclick="router('tetofu')">TETOFU</a>
        </nav>

        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <div style="font-size: 0.8em; color: var(--text-dim); margin-bottom: 10px; font-family: var(--font-display);">EXTERNAL TOOLS</div>
            <a href="https://selmtoe.github.io/Tetris_Simulator/" target="_blank" class="nav-item" style="padding: 8px 15px; font-size: 0.9em;">Simulator ↗</a>
            <a href="https://selmtoe.github.io/Tetris_Simulator/F/index.html" target="_blank" class="nav-item" style="padding: 8px 15px; font-size: 0.9em;">Fumen Editor ↗</a>
        </div>
    </aside>

    <main id="main-view" class="main-content"></main>
</div>

<script src="data/articles.js"></script>
<script src="data/videos.js"></script>
<script src="data/tetofu.js"></script>

<script>
    // --- 背景のエフェクト（サイバーパンクパーティクル） ---
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    let width, height, particles = [];
    function initCanvas() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        particles = Array.from({length: 80}, () => ({
            x: Math.random() * width, y: Math.random() * height,
            vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5,
            size: Math.random() * 2, alpha: Math.random() * 0.5
        }));
    }
    window.addEventListener('resize', initCanvas);
    initCanvas();
    function animate() {
        ctx.clearRect(0, 0, width, height);
        particles.forEach(p => {
            p.x += p.vx; p.y += p.vy;
            if (p.x < 0 || p.x > width || p.y < 0 || p.y > height) {
                p.x = Math.random() * width; p.y = Math.random() * height;
            }
            ctx.fillStyle = `rgba(0, 229, 255, ${p.alpha})`;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
        });
        requestAnimationFrame(animate);
    }
    animate();

    // --- データ取得ヘルパー ---
    const getArticles = () => (window.LAB_ARTICLES || []).sort((a,b) => new Date(b.date) - new Date(a.date));
    const getVideos = () => (window.LAB_VIDEOS || []).sort((a,b) => new Date(b.date) - new Date(a.date));
    const getTetofu = () => (window.LAB_TETOFU || []).sort((a,b) => new Date(b.date) - new Date(a.date));

    // YouTube API連携用
    let ytPlayers = {};
    function onYouTubeIframeAPIReady() { /* Playerは動的に生成 */ }

    // --- ルーティング ---
    const mainView = document.getElementById('main-view');
    function router(page, id = null) {
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const activeTab = document.querySelector(`.nav-item[onclick="router('${page}')"]`);
        if(activeTab) activeTab.classList.add('active');

        mainView.innerHTML = '';
        window.scrollTo({top: 0, behavior: 'smooth'});

        switch(page) {
            case 'dashboard': renderDashboard(); break;
            case 'articles': id ? renderArticleDetail(id) : renderArticleList(); break;
            case 'videos': renderVideos(); break;
            case 'tetofu': renderTetofu(); break;
        }
    }

    // --- UI レンダリング関数 ---

    // 1. DASHBOARD
    function renderDashboard() {
        mainView.innerHTML = `<h2 class="section-title">LATEST UPDATES</h2><div class="grid" id="dash-grid"></div>`;
        const grid = document.getElementById('dash-grid');
        
        // 最新記事2件、動画2件、テト譜2件をマージして表示
        const recent = [
            ...getArticles().slice(0, 2).map(i => ({...i, category: 'ARTICLE', action: () => router('articles', i.id)})),
            ...getVideos().slice(0, 2).map(i => ({...i, category: 'VIDEO', action: () => router('videos')})),
            ...getTetofu().slice(0, 2).map(i => ({...i, category: 'TETOFU', action: () => window.open(i.url, '_blank')}))
        ].sort((a,b) => new Date(b.date) - new Date(a.date));

        recent.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.onclick = item.action;
            card.innerHTML = `
                <div class="card-meta"><span>${item.category}</span><span>${item.date}</span></div>
                <div class="card-title">${item.title}</div>
                <div>${(item.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}</div>
            `;
            grid.appendChild(card);
        });
    }

    // 2. ARTICLES (一覧)
    function renderArticleList() {
        mainView.innerHTML = `<h2 class="section-title">RESEARCH ARTICLES</h2><div class="grid" id="article-grid"></div>`;
        const grid = document.getElementById('article-grid');
        
        getArticles().forEach(article => {
            const card = document.createElement('div');
            card.className = 'card';
            if(article.externalUrl) {
                card.onclick = () => window.open(article.externalUrl, '_blank');
            } else {
                card.onclick = () => router('articles', article.id);
            }
            
            card.innerHTML = `
                <div class="card-meta"><span>${article.externalUrl ? 'EXTERNAL' : 'INTERNAL'}</span><span>${article.date}</span></div>
                <div class="card-title">${article.title}</div>
                <p style="color:var(--text-dim); font-size:0.9em; margin-bottom:15px; flex-grow:1;">${article.description || ''}</p>
                <div>${(article.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}</div>
            `;
            grid.appendChild(card);
        });
    }

    // 3. ARTICLE (詳細 & 関連記事)
    function renderArticleDetail(id) {
        const article = getArticles().find(a => a.id === id);
        if(!article) return router('articles');

        // HTMLインジェクション対応 (シミュレータ等のiframe展開を許可)
        let html = `
            <div class="article-header">
                <button class="btn" onclick="router('articles')" style="margin-bottom: 20px;">← Back to Articles</button>
                <div class="card-meta"><span>${article.date}</span></div>
                <h1 class="article-title">${article.title}</h1>
                <div>${(article.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}</div>
            </div>
            <div class="article-body">${article.content}</div>
        `;

        // 関連記事のサジェスト（タグの共通数で計算）
        const related = getArticles()
            .filter(a => a.id !== id)
            .map(a => {
                const commonTags = a.tags.filter(t => article.tags.includes(t)).length;
                return { ...a, score: commonTags };
            })
            .filter(a => a.score > 0)
            .sort((a,b) => b.score - a.score)
            .slice(0, 3);

        if(related.length > 0) {
            html += `<div class="related-section"><h3 class="section-title" style="font-size:24px;">RELATED</h3><div class="grid">`;
            related.forEach(r => {
                html += `
                    <div class="card" onclick="router('articles', '${r.id}')">
                        <div class="card-title" style="font-size:1.1em;">${r.title}</div>
                        <div>${r.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>
                    </div>`;
            });
            html += `</div></div>`;
        }

        mainView.innerHTML = html;
    }

    // 4. VIDEOS (YouTubeとタイムスタンプ)
    function renderVideos() {
        mainView.innerHTML = `<h2 class="section-title">VIDEO ANALYSIS</h2><div id="video-list"></div>`;
        const list = document.getElementById('video-list');
        ytPlayers = {}; // リセット

        getVideos().forEach((v, index) => {
            const playerId = `yt-player-${index}`;
            const container = document.createElement('div');
            container.className = 'card';
            container.style.marginBottom = '30px';
            container.style.display = 'block'; // grid除外
            
            let timestampsHtml = '';
            if(v.timestamps && v.timestamps.length > 0) {
                timestampsHtml = `<div class="timestamp-list" style="margin-top: 20px;">`;
                v.timestamps.forEach(ts => {
                    const m = Math.floor(ts.time / 60);
                    const s = String(ts.time % 60).padStart(2, '0');
                    timestampsHtml += `
                        <button class="timestamp-btn" onclick="seekVideo('${playerId}', ${ts.time})">
                            <span class="time-badge">${m}:${s}</span>
                            <span>${ts.label}</span>
                        </button>`;
                });
                timestampsHtml += `</div>`;
            }

            container.innerHTML = `
                <div class="card-meta"><span>${v.date}</span></div>
                <h3 class="card-title">${v.title}</h3>
                <div>${(v.tags || []).map(t => `<span class="tag">${t}</span>`).join('')}</div>
                <div class="video-wrapper" style="margin-top: 15px;">
                    <div id="${playerId}"></div>
                </div>
                ${timestampsHtml}
            `;
            list.appendChild(container);

            // YouTube Playerの初期化
            if (window.YT && YT.Player) {
                ytPlayers[playerId] = new YT.Player(playerId, {
                    videoId: v.youtubeId,
                    playerVars: { 'rel': 0 }
                });
            }
        });
    }

    // タイムスタンプからのシーク処理
    window.seekVideo = function(playerId, seconds) {
        const player = ytPlayers[playerId];
        if (player && typeof player.seekTo === 'function') {
            player.seekTo(seconds, true);
            player.playVideo();
        }
    }

    // 5. TETOFU
    function renderTetofu() {
        mainView.innerHTML = `<h2 class="section-title">TETOFU (譜面)</h2><div class="grid" id="tetofu-grid"></div>`;
        const grid = document.getElementById('tetofu-grid');
        
        getTetofu().forEach(t => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-meta"><span>${t.date}</span></div>
                <div class="card-title">${t.title}</div>
                <p style="color:var(--text-dim); font-size:0.9em; margin-bottom:15px; flex-grow:1;">${t.notes || ''}</p>
                <div>${(t.tags || []).map(tag => `<span class="tag">${tag}</span>`).join('')}</div>
                <a href="${t.url}" target="_blank" class="btn" style="margin-top:15px; display:block;">エディタで開く / シミュレート</a>
            `;
            grid.appendChild(card);
        });
    }

    // 初期化
    setTimeout(() => router('dashboard'), 100);

</script>
</body>
</html>
